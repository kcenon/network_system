name: 'Setup thread_system'
description: 'Install thread_system for network_system builds'
runs:
  using: 'composite'
  steps:
    - name: Install thread_system (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        git clone https://github.com/kcenon/thread_system.git /tmp/thread_system
        cd /tmp/thread_system

        # Apply FMT header fix patch
        git apply "${GITHUB_WORKSPACE}/patches/thread_system_fmt_fix.patch"

        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        sudo cmake --install build --prefix /usr/local
        echo "THREAD_SYSTEM_INCLUDE_DIR=/usr/local/include" >> $GITHUB_ENV
        echo "THREAD_SYSTEM_LIBRARY=/usr/local/lib/libthread_system.a" >> $GITHUB_ENV

    - name: Install thread_system (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        git clone https://github.com/kcenon/thread_system.git C:\temp\thread_system
        cd C:\temp\thread_system

        # Apply FMT header fix patch
        git apply "$env:GITHUB_WORKSPACE\patches\thread_system_fmt_fix.patch"

        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        cmake --install build --prefix C:\thread_system
        echo "THREAD_SYSTEM_INCLUDE_DIR=C:\thread_system\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "THREAD_SYSTEM_LIBRARY=C:\thread_system\lib\thread_system.lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
