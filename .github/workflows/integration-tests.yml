name: Integration Tests

on:
  push:
    branches: [ main, develop, feat/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  integration-tests:
    name: ${{ matrix.os }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Debug, Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout common_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/common_system
          path: common_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout thread_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/thread_system
          path: thread_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout logger_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/logger_system
          path: logger_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout container_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/container_system
          path: container_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ecosystem dependencies
        shell: bash
        run: |
          # Build common_system (Tier 0 - must be first)
          if [ -d "common_system" ]; then
            echo "Building common_system..."
            cd common_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF
            cmake --build build
            cmake --install build --prefix ${{ github.workspace }}/deps/install
            cd ..
          fi

          # Build thread_system
          if [ -d "thread_system" ]; then
            echo "Building thread_system..."
            cd thread_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
              -DCOMMON_SYSTEM_INCLUDE_DIR=${{ github.workspace }}/deps/install/include \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF \
              -DBUILD_INTEGRATION_TESTS=OFF
            cmake --build build --target ThreadSystem
            cmake --install build --prefix ${{ github.workspace }}/deps/install
            cd ..
          fi

          # Build logger_system
          if [ -d "logger_system" ]; then
            echo "Building logger_system..."
            cd logger_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
              -DCOMMON_SYSTEM_INCLUDE_DIR=${{ github.workspace }}/deps/install/include \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF \
              -DLOGGER_BUILD_INTEGRATION_TESTS=OFF
            cmake --build build
            cmake --install build --prefix ${{ github.workspace }}/deps/install
            cd ..
          fi

          # Build container_system
          if [ -d "container_system" ]; then
            echo "Building container_system..."
            cd container_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
              -DCOMMON_SYSTEM_INCLUDE_DIR=${{ github.workspace }}/deps/install/include \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF
            cmake --build build
            # Install may fail due to missing files in container_system CMake config
            cmake --install build --prefix ${{ github.workspace }}/deps/install || true
            cd ..
          fi

          # Remove GoogleTest from deps/install to avoid ABI conflicts with system GoogleTest
          # This ensures network_system uses the system-installed GoogleTest (brew/apt)
          # Must remove CMake config files too, otherwise find_package finds broken config
          echo "Removing GoogleTest from deps/install to avoid ABI conflicts..."
          rm -f ${{ github.workspace }}/deps/install/lib/libgtest*.a 2>/dev/null || true
          rm -f ${{ github.workspace }}/deps/install/lib/libgmock*.a 2>/dev/null || true
          rm -rf ${{ github.workspace }}/deps/install/include/gtest 2>/dev/null || true
          rm -rf ${{ github.workspace }}/deps/install/include/gmock 2>/dev/null || true
          rm -rf ${{ github.workspace }}/deps/install/lib/cmake/GTest 2>/dev/null || true

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgtest-dev \
            libasio-dev \
            libfmt-dev \
            libssl-dev \
            liblz4-dev \
            zlib1g-dev \
            lcov
          # Verify OpenSSL version (should be 3.x on Ubuntu 22.04+)
          openssl version

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            cmake \
            ninja \
            googletest \
            asio \
            fmt \
            openssl@3 \
            lz4 \
            zlib \
            lcov
          # Verify OpenSSL version
          openssl version

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
            -DBUILD_TESTS=ON \
            -DNETWORK_BUILD_INTEGRATION_TESTS=ON \
            -DENABLE_COVERAGE=${{ matrix.build_type == 'Debug' && 'ON' || 'OFF' }} \
            -DBUILD_SAMPLES=OFF \
            -DBUILD_WITH_COMMON_SYSTEM=ON \
            -DBUILD_WITH_LOGGER_SYSTEM=ON \
            -DBUILD_WITH_THREAD_SYSTEM=ON \
            -DBUILD_WITH_CONTAINER_SYSTEM=ON \
            -DBUILD_MESSAGING_BRIDGE=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Run Integration Tests
        working-directory: build
        run: |
          ctest --output-on-failure -R "ConnectionLifecycle|ProtocolIntegration|NetworkPerformance|ErrorHandling"

      - name: Generate Coverage Report (Debug only)
        if: matrix.build_type == 'Debug' && runner.os == 'Linux'
        working-directory: build
        run: |
          # Create coverage directory
          mkdir -p coverage

          # Capture coverage data (ignore known mismatches from system headers)
          export GENINFO_OPTS="--ignore-errors mismatch,gcov,source,unused"

          lcov --capture \
            --directory . \
            --output-file coverage/coverage.info \
            --ignore-errors mismatch,gcov,source,unused,negative \
            --rc lcov_branch_coverage=1

          # Remove system and test files and external dependencies
          lcov --remove coverage/coverage.info \
            '/usr/*' \
            '*/tests/*' \
            '*/integration_tests/*' \
            '*/test/*' \
            '*/gtest/*' \
            '*/googletest/*' \
            '*/build/_deps/*' \
            '*/asio/*' \
            --output-file coverage/coverage_filtered.info \
            --ignore-errors mismatch,unused,negative \
            --rc lcov_branch_coverage=1

          # Generate HTML report
          genhtml coverage/coverage_filtered.info \
            --output-directory coverage/html \
            --ignore-errors source \
            --rc lcov_branch_coverage=1

          # Print coverage summary
          lcov --list coverage/coverage_filtered.info \
            --ignore-errors unused \
            --rc lcov_branch_coverage=1

      - name: Upload Coverage Report
        if: matrix.build_type == 'Debug' && runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        # Continue even if artifact upload fails due to GitHub infrastructure issues
        continue-on-error: true
        with:
          name: coverage-report-${{ matrix.os }}-${{ matrix.build_type }}
          path: build/coverage/html
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        # Continue even if artifact upload fails due to GitHub infrastructure issues
        # This prevents transient upload timeouts from failing the entire workflow
        continue-on-error: true
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            build/Testing/Temporary/LastTest.log
          retention-days: 7

  performance-validation:
    name: Performance Baseline Validation
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout common_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/common_system
          path: common_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout thread_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/thread_system
          path: thread_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout logger_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/logger_system
          path: logger_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout container_system
        uses: actions/checkout@v4
        with:
          repository: kcenon/container_system
          path: container_system
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ecosystem dependencies
        shell: bash
        run: |
          # Build common_system (Tier 0 - must be first)
          if [ -d "common_system" ]; then
            echo "Building common_system..."
            cd common_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF
            cmake --build build
            cmake --install build --prefix ${{ github.workspace }}/deps/install
            cd ..
          fi

          # Build thread_system
          if [ -d "thread_system" ]; then
            echo "Building thread_system..."
            cd thread_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
              -DCOMMON_SYSTEM_INCLUDE_DIR=${{ github.workspace }}/deps/install/include \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF \
              -DBUILD_INTEGRATION_TESTS=OFF
            cmake --build build --target ThreadSystem
            cmake --install build --prefix ${{ github.workspace }}/deps/install
            cd ..
          fi

          # Build logger_system
          if [ -d "logger_system" ]; then
            echo "Building logger_system..."
            cd logger_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
              -DCOMMON_SYSTEM_INCLUDE_DIR=${{ github.workspace }}/deps/install/include \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF \
              -DLOGGER_BUILD_INTEGRATION_TESTS=OFF
            cmake --build build
            cmake --install build --prefix ${{ github.workspace }}/deps/install
            cd ..
          fi

          # Build container_system
          if [ -d "container_system" ]; then
            echo "Building container_system..."
            cd container_system
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
              -DCOMMON_SYSTEM_INCLUDE_DIR=${{ github.workspace }}/deps/install/include \
              -DBUILD_TESTS=OFF \
              -DBUILD_EXAMPLES=OFF \
              -DBUILD_SAMPLES=OFF
            cmake --build build
            # Install may fail due to missing files in container_system CMake config
            cmake --install build --prefix ${{ github.workspace }}/deps/install || true
            cd ..
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgtest-dev \
            libasio-dev \
            libfmt-dev

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps/install \
            -DBUILD_TESTS=ON \
            -DNETWORK_BUILD_INTEGRATION_TESTS=ON \
            -DBUILD_SAMPLES=OFF \
            -DBUILD_WITH_COMMON_SYSTEM=ON \
            -DBUILD_WITH_LOGGER_SYSTEM=ON \
            -DBUILD_WITH_THREAD_SYSTEM=ON \
            -DBUILD_WITH_CONTAINER_SYSTEM=ON \
            -DBUILD_MESSAGING_BRIDGE=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Run Performance Tests
        working-directory: build
        run: |
          ctest --output-on-failure -R "NetworkPerformance" -V

      - name: Validate Performance Baselines
        run: |
          echo "Performance baseline validation"
          echo "Expected baselines:"
          echo "  - Connection establishment: < 100ms"
          echo "  - Message latency P50: < 10ms"
          echo "  - Message latency P95: < 50ms"
          echo "  - Throughput: > 1000 msg/s"
          echo "  - Concurrent connections: > 20"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [integration-tests, performance-validation]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "Integration Test Suite Complete"
          echo "================================"
          echo "Test Suites:"
          echo "  - Connection Lifecycle Tests"
          echo "  - Protocol Integration Tests"
          echo "  - Network Performance Tests"
          echo "  - Error Handling Tests"
          echo ""
          echo "Coverage reports available in artifacts"
