name: Sanitizer Tests

on:
  push:
    branches: [ main, phase-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sanitizer-tests:
    name: ${{ matrix.sanitizer.name }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        sanitizer:
          - name: AddressSanitizer
            option: ENABLE_ASAN
            env_var: ASAN_OPTIONS
            env_value: "halt_on_error=0:detect_leaks=1"
          - name: ThreadSanitizer
            option: ENABLE_TSAN
            env_var: TSAN_OPTIONS
            env_value: "halt_on_error=0:second_deadlock_stack=1"
          - name: UndefinedBehaviorSanitizer
            option: ENABLE_UBSAN
            env_var: UBSAN_OPTIONS
            # Note: suppressions path is set dynamically in the test step
            env_value: "halt_on_error=0:print_stacktrace=1"

    steps:
    - name: Checkout network_system
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: network_system

    - name: Checkout common_system
      uses: actions/checkout@v4
      with:
        repository: kcenon/common_system
        path: common_system
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Note: We don't install libasio-dev here because Ubuntu 24.04 ships ASIO 1.28.1
        # which has a bug where the recycling allocator returns null under sanitizers.
        # We install ASIO 1.32+ from source below.
        sudo apt-get install -y cmake ninja-build clang libgtest-dev libfmt-dev libssl-dev liblz4-dev zlib1g-dev

    - name: Install ASIO from source
      run: |
        # Ubuntu 24.04's libasio-dev (1.28.1) has a bug where the recycling allocator
        # can return null when running under sanitizers, causing SEGV. ASIO 1.31.0+
        # has fixes for the recycling allocator. We install ASIO 1.32.0 from source.
        # See: https://www.boost.org/doc/libs/develop/doc/html/boost_asio/history.html
        cd ${{ github.workspace }}
        curl -L https://github.com/chriskohlhoff/asio/archive/asio-1-32-0.tar.gz -o asio.tar.gz
        tar xzf asio.tar.gz
        sudo mkdir -p /usr/local/include
        sudo cp -r asio-asio-1-32-0/asio/include/asio /usr/local/include/
        sudo cp asio-asio-1-32-0/asio/include/asio.hpp /usr/local/include/
        echo "Installed ASIO 1.32.0 to /usr/local/include"
        ls -la /usr/local/include/asio.hpp

    - name: Set up compiler
      run: |
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV

    - name: Configure CMake with ${{ matrix.sanitizer.name }}
      run: |
        cd network_system
        cmake -B build -S . \
          -GNinja \
          -DCMAKE_BUILD_TYPE=Debug \
          -D${{ matrix.sanitizer.option }}=ON \
          -DBUILD_WITH_COMMON_SYSTEM=OFF \
          -DBUILD_WITH_LOGGER_SYSTEM=OFF \
          -DBUILD_WITH_THREAD_SYSTEM=OFF \
          -DBUILD_WITH_CONTAINER_SYSTEM=OFF \
          -DBUILD_MESSAGING_BRIDGE=OFF \
          -DBUILD_TESTS=ON \
          -DBUILD_SAMPLES=OFF \
          -DASIO_INCLUDE_DIR=/usr/local/include \
          -DSKIP_ASIO_RECYCLING_WORKAROUND=ON

    - name: Build with ${{ matrix.sanitizer.name }}
      run: |
        cd network_system
        cmake --build build -j

    - name: Run tests with ${{ matrix.sanitizer.name }}
      run: |
        cd network_system/build
        # For UBSAN, append suppressions file path to options
        if [ "${{ matrix.sanitizer.option }}" = "ENABLE_UBSAN" ]; then
          export UBSAN_OPTIONS="${{ matrix.sanitizer.env_value }}:suppressions=${{ github.workspace }}/network_system/cmake/ubsan.supp"
          echo "UBSAN_OPTIONS=$UBSAN_OPTIONS"
        fi
        ctest --output-on-failure --verbose -LE no_sanitizer
      env:
        ${{ matrix.sanitizer.env_var }}: ${{ matrix.sanitizer.env_value }}

    - name: Upload sanitizer logs
      if: failure()
      uses: actions/upload-artifact@v4
      continue-on-error: true
      with:
        name: sanitizer-logs-${{ matrix.sanitizer.name }}-${{ matrix.os }}
        path: |
          network_system/build/Testing/Temporary/LastTest.log
          network_system/build/**/*.log
        retention-days: 7

  sanitizer-summary:
    name: Sanitizer Test Summary
    needs: sanitizer-tests
    runs-on: ubuntu-24.04
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# Sanitizer Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sanitizer tests completed using CMake options:" >> $GITHUB_STEP_SUMMARY
        echo "- ENABLE_ASAN: AddressSanitizer" >> $GITHUB_STEP_SUMMARY
        echo "- ENABLE_TSAN: ThreadSanitizer" >> $GITHUB_STEP_SUMMARY
        echo "- ENABLE_UBSAN: UndefinedBehaviorSanitizer" >> $GITHUB_STEP_SUMMARY
